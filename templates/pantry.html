<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pantry - Smart Indian Pantry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/">Smart Indian Pantry</a>
            <div id="nav-links">
                <a href="/recipes-page" class="btn btn-outline-primary rounded-pill me-2">Recommendations</a>
                <button onclick="logout()" class="btn btn-link text-muted text-decoration-none">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container my-5" style="padding-bottom: 50px;">
        <div class="row section-header mb-4">
            <div class="col-12">
                <span class="badge bg-primary mb-2">Pantry Manager</span>
                <h2 class="display-5 fw-bold text-white">Customize Your <span class="text-primary">Ingredients</span>
                </h2>
                <p class="text-secondary">Search and select items you have at home.</p>
            </div>
        </div>

        <div class="row g-4">
            <!-- Main Content Area (Quick Kitchen & All Ingredients) -->
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-end mb-4 flex-wrap gap-3">
                    <div>
                        <h3 class="fw-bold text-white mb-0" style="letter-spacing: 1px;">QUICK KITCHEN</h3>
                        <p class="text-secondary small mb-0">Select your household staples.</p>
                    </div>
                    <a href="javascript:void(0)" onclick="toggleSearch()"
                        class="text-primary text-decoration-none fw-bold small" id="toggle-search-btn">
                        Click Here For All Ingredients
                    </a>
                </div>

                <!-- Error Display -->
                <div id="error-alert"
                    class="alert alert-danger d-none mb-4 bg-danger bg-opacity-10 border-danger text-danger">
                    <div class="d-flex justify-content-between align-items-center">
                        <span id="error-message">Something went wrong.</span>
                        <button onclick="initPantry()" class="btn btn-sm btn-danger px-3">Retry</button>
                    </div>
                </div>

                <div class="auth-container w-100 m-0 mb-4 p-4 shadow-lg border-0"
                    style="background: rgba(30, 41, 59, 0.4);">

                    <!-- Search Bar (Hidden by default) -->
                    <div id="search-container" class="d-none animate-fade-in">
                        <input type="text" id="search-box" class="form-control form-control-lg mb-4"
                            placeholder="ðŸ” Type to search 3,000+ ingredients...">
                    </div>

                    <!-- Ingredients Grid -->
                    <div id="ingredient-container" class="row">
                        <div class="col-12 text-center py-5" id="pantry-loader">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3 text-secondary">Loading your ingredients...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar (Selection) -->
            <div class="col-lg-4">
                <div class="auth-container w-100 m-0 p-4 sticky-top shadow-lg border-0"
                    style="top: 100px; background: rgba(30, 41, 59, 0.6);">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold m-0 text-white">My Selection</h4>
                        <span id="selected-count" class="badge bg-primary rounded-pill">0</span>
                    </div>
                    <div id="selected-list" class="mb-4 text-secondary small"
                        style="max-height: 300px; overflow-y: auto;">
                        No ingredients selected yet.
                    </div>
                    <button id="save-pantry" class="btn btn-primary w-100 py-3 fw-bold">
                        Find Recipes Now â†’
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='base.js') }}"></script>
    <script>
        let allIngredients = [];
        let selectedIds = new Set();
        let isSearchActive = false;

        async function initPantry() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error("No token found, redirecting...");
                window.location.href = '/auth';
                return;
            }

            const errorAlert = document.getElementById('error-alert');
            const loader = document.getElementById('pantry-loader');

            // Show loader, hide error
            if (loader) loader.classList.remove('d-none');
            errorAlert.classList.add('d-none');

            try {
                console.log("Fetching ingredients from:", API_BASE + '/ingredients');

                // Fetch all ingredients
                const res = await fetch(API_BASE + '/ingredients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    if (res.status === 401) {
                        localStorage.removeItem('token');
                        window.location.href = '/auth';
                        return;
                    }
                    throw new Error(`Server returned ${res.status}: ${res.statusText}`);
                }

                allIngredients = await res.json();
                console.log("Successfully fetched " + allIngredients.length + " ingredients.");

                // Fetch user's current pantry
                const pantryRes = await fetch(API_BASE + '/pantry', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const userPantry = await pantryRes.json();
                userPantry.forEach(i => selectedIds.add(i.id));

                renderIngredients();
                updateCount();
            } catch (err) {
                console.error("CRITICAL PANTRY ERROR:", err);
                errorAlert.classList.remove('d-none');
                document.getElementById('error-message').innerText = "Unable to load ingredients. Please try again.";
                if (loader) loader.classList.add('d-none');
            }
        }

        function toggleSearch() {
            const container = document.getElementById('search-container');
            const btn = document.getElementById('toggle-search-btn');
            isSearchActive = container.classList.contains('d-none');

            if (isSearchActive) {
                container.classList.remove('d-none');
                btn.innerText = 'Back to Quick Selection';
            } else {
                container.classList.add('d-none');
                btn.innerText = 'Click Here For All Ingredients';
                document.getElementById('search-box').value = '';
            }
            renderIngredients(document.getElementById('search-box').value);
        }

        function renderIngredients(filter = '') {
            const container = document.getElementById('ingredient-container');
            if (!container) return;
            container.innerHTML = '';

            const activeFilter = filter.trim().toLowerCase();
            const searchUIOpen = !document.getElementById('search-container').classList.contains('d-none');

            // Categorize
            const groups = allIngredients.reduce((acc, ing) => {
                const nameMatch = !activeFilter || ing.name.toLowerCase().includes(activeFilter);
                if (!nameMatch) return acc;

                // Logic: 
                // 1. If search UI is closed and no filter -> Show ONLY Quick Kitchen
                // 2. If search UI is open OR filter is active -> Show grouped All
                if (!searchUIOpen && !activeFilter && ing.category !== 'Quick Kitchen') return acc;

                const cat = (searchUIOpen || activeFilter) ? (ing.category || 'Other Ingredients') : 'Quick Kitchen';
                acc[cat] = acc[cat] || [];
                acc[cat].push(ing);
                return acc;
            }, {});

            const categories = Object.keys(groups);
            if (categories.length === 0) {
                container.innerHTML = `<div class="col-12 text-center py-5">
                    <p class="text-secondary opacity-50">No ingredients match your search.</p>
                </div>`;
                return;
            }

            // Order: Quick Kitchen first
            const sortedCats = categories.sort((a, b) => {
                if (a === 'Quick Kitchen') return -1;
                if (b === 'Quick Kitchen') return 1;
                return a.localeCompare(b);
            });

            sortedCats.forEach(cat => {
                const items = groups[cat];
                const section = document.createElement('div');
                section.className = 'col-12 mb-5';

                // Header
                section.innerHTML = `<h6 class="text-uppercase fw-bold text-primary mb-3 small" style="opacity: 0.7;">${cat}</h6>`;

                // Checkbox Grid
                const grid = document.createElement('div');
                grid.className = 'row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3';

                items.forEach(ing => {
                    const itemCol = document.createElement('div');
                    itemCol.className = 'col';
                    const isSelected = selectedIds.has(ing.id);

                    itemCol.innerHTML = `
                        <div class="ingredient-checkbox-card ${isSelected ? 'selected' : ''}" onclick="toggleIngredient(${ing.id})">
                            <div class="d-flex align-items-start gap-3">
                                <div class="form-check m-0">
                                    <input class="form-check-input" type="checkbox" ${isSelected ? 'checked' : ''} style="pointer-events: none;">
                                </div>
                                <label class="form-check-label small lh-sm" style="cursor: pointer; user-select: none;">${ing.name}</label>
                            </div>
                        </div>
                    `;
                    grid.appendChild(itemCol);
                });

                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        function toggleIngredient(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            renderIngredients(document.getElementById('search-box').value);
            updateCount();
        }

        function updateCount() {
            const countEl = document.getElementById('selected-count');
            const listEl = document.getElementById('selected-list');
            countEl.innerText = selectedIds.size;

            if (selectedIds.size === 0) {
                listEl.innerHTML = '<p class="text-center py-3 opacity-50">No items selected.</p>';
                return;
            }

            const selectedNames = allIngredients
                .filter(i => selectedIds.has(i.id))
                .map(i => `
                    <div class="d-flex justify-content-between align-items-center mb-2 bg-white bg-opacity-5 p-2 rounded small animate-fade-in shadow-sm">
                        <span class="text-white text-truncate me-2">${i.name}</span>
                        <span class="text-danger" style="cursor: pointer; padding: 0 5px;" onclick="toggleIngredient(${i.id})">âœ•</span>
                    </div>
                `)
                .join('');
            listEl.innerHTML = selectedNames;
        }

        document.getElementById('search-box').addEventListener('input', (e) => {
            renderIngredients(e.target.value);
        });

        document.getElementById('save-pantry').addEventListener('click', async () => {
            const btn = document.getElementById('save-pantry');
            const token = localStorage.getItem('token');

            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            btn.disabled = true;

            try {
                const res = await fetch(API_BASE + '/pantry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ingredient_ids: Array.from(selectedIds) })
                });

                if (res.ok) {
                    window.location.href = '/recipes-page';
                } else {
                    throw new Error("Failed to save pantry.");
                }
            } catch (err) {
                alert("Error saving pantry: " + err.message);
                btn.innerHTML = 'Find Recipes Now â†’';
                btn.disabled = false;
            }
        });

        // Use DOMContentLoaded to ensure elements are ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Pantry script initialized.");
            initPantry();
        });
    </script>
    <style>
        .pantry-footer {
            z-index: 1001;
        }

        body {
            padding-bottom: 100px;
        }
    </style>
</body>

</html>